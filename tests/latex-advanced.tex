%!TeX program = LuaLaTeX

% lua-widow-control
% https://github.com/gucci-on-fleek/lua-widow-control
% SPDX-License-Identifier: MPL-2.0+
% SPDX-FileCopyrightText: 2021 Max Chernoff

% Pathological test file to look for edge cases. Includes just about everything that I could possibly think of.

\documentclass{article}

\usepackage{lua-widow-control}

\usepackage[stretch=30, shrink=30]{microtype}

\usepackage[english]{babel}

\usepackage{amsmath, etoolbox, pgffor, blindtext, kantlipsum, multicol, longtable}

\let\pagebreakcommand=\clearpage
\newcommand{\texcsname}[1]{\texttt{\textbackslash#1}}
\renewcommand{\quotation}[1]{``#1''}
\newcommand{\printlocation}[1]{\write16{===#1:\the\count0===}}

\allowdisplaybreaks
\parskip=0pt
\vfuzz=1pt

\let\aligncontents=\relax
\foreach \x in {1, ..., 40} {
    \xappto\aligncontents{\x = \x}
    \gappto\aligncontents{\\}
}

\let\tabularcontents=\relax
\foreach \x in {1, ..., 40} {
    \xappto\tabularcontents{\x & \x & \x}
    \gappto\tabularcontents{\\}
}

\let\longtabularcontents=\relax
\foreach \x in {1, ..., 200} {
    \xappto\longtabularcontents{\x & \x & \x}
    \gappto\longtabularcontents{\\}
}

\newcommand{\testtable}{%
    \begin{tabular}{ccc}
    \hline
        \tabularcontents
    \hline
    \end{tabular}%
}

\newcommand{\footnotetest}{%
    \foreach \x in {1, ..., 48} {
        AAA AAA\footnote{\x}\ 
    }\clearpage
}

\usepackage{calc} % Issue #2

\begin{document}
    \begin{align*}
        \aligncontents
    \end{align*}
    \clearpage

    \tableofcontents

    \clearpage

    \foreach \x in {4, ..., 8} {
        \foreach \y in {1, ..., \x} {
            A\par
        }
        \testtable\clearpage
    }

    \tableofcontents\clearpage

    \lwcdisable
    \footnotetest

    \lwcenable
    \footnotetest

    \input generic-basic

    \blindmathpaper

    \Blinddocument\clearpage

    \foreach \x in {1, ..., 15} {
        \begin{figure}[tb]
            \input zapf
        \end{figure}
    }

    \kant[1-164]

    \clearpage 

    \begin{multicols*}{5}
        \renewcommand{\blindmarkup}[1]{\footnote{#1}}
        \raggedright
        \parindent=2em
        \Blindtext\Blindtext\Blindtext\Blindtext
    \end{multicols*}

    \begin{longtable}{c|c|c}
    \hline
        A & \multicolumn{2}{|c|}{A} \\
        \endhead
        \hline
        \multicolumn{2}{|c|}{Z} & Z \\
        \hline
        \endfoot
        \longtabularcontents
    \end{longtable}

    \directlua{lwc.emergency_stretch = tex.maxdimen}

    \lwcenable\lwcenable\lwcenable\lwcenable\lwcenable\lwcenable\lwcenable
    
    \clearpage

    \part[PART!]{Part}
    \kant[1-5]

    \section[SECTION!]{Section}
    \kant[6-10]

    \subsection[SUBSECTION!]{Subsection}
    \kant[11-15]

    \subsubsection[SUBSUBSECTION!]{Subsubsection}
    \kant[16-20]

    \paragraph[PARAGRAPH!]{Paragraph}
    \kant[21-25]
    
    \subparagraph[SUBPARAGRAPH!]{Subparagraph}
    \kant[21-25]

    \part[A]{Part}
    \kant[26-30]

    \section[B]{Section}
    \kant[31-35]

    \subsection[C]{Subsection}
    \kant[36-40]

    \subsubsection[D]{Subsubsection}
    \kant[41-45]

    \paragraph[E]{Paragraph}
    \kant[46-50]
    
    \subparagraph[F]{Subparagraph}
    \kant[51-55]

    The End.
    
    
\end{document}
